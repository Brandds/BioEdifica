# üìö Guia de Testes Unit√°rios com JUnit - BioEdifica

## üéØ Vis√£o Geral

Este documento descreve os testes unit√°rios implementados para o backend do BioEdifica utilizando **JUnit 5** e **Mockito**. Os testes focam na camada de **Service** (l√≥gica de neg√≥cio) para garantir a qualidade e confiabilidade do c√≥digo.

## üõ†Ô∏è Tecnologias Utilizadas

| Tecnologia | Vers√£o | Finalidade |
|------------|--------|------------|
| **JUnit 5** | 5.9.x | Framework de testes unit√°rios |
| **Mockito** | 5.x | Framework para cria√ß√£o de mocks |
| **AssertJ** | 3.x | Biblioteca para assertions mais fluentes |
| **Spring Boot Test** | 3.2.5 | Suporte a testes no Spring Boot |
| **Lombok** | - | Gera√ß√£o autom√°tica de c√≥digo (Builder, etc) |


## üß™ Estrutura dos Testes

### Localiza√ß√£o dos Arquivos

```
src/test/java/com/edifica/bioedifica/service/
‚îú‚îÄ‚îÄ EstadoServiceTest.java        # Testes do service de Estados (7 testes)
‚îú‚îÄ‚îÄ CidadeServiceTest.java        # Testes do service de Cidades (5 testes)
‚îú‚îÄ‚îÄ ProjetoServiceTest.java       # Testes do service de Projetos (5 testes)
‚îú‚îÄ‚îÄ UsuarioServiceTest.java       # Testes do service de Usu√°rios (12 testes)
‚îú‚îÄ‚îÄ CalculoTermicoServiceTest.java # Testes de c√°lculos t√©rmicos NBR 15220-2 (12 testes)
‚îú‚îÄ‚îÄ MockMaterialServiceTest.java  # Testes de leitura e filtro de materiais (21 testes)
‚îî‚îÄ‚îÄ [Outros testes de services]
```

### Anatomia de um Teste

```java
@ExtendWith(MockitoExtension.class)  // 1. Habilita Mockito
class NomeServiceTest {

    @Mock                              // 2. Cria mock de depend√™ncia
    private IRepository repository;

    @InjectMocks                       // 3. Injeta mocks no service
    private NomeService service;

    @BeforeEach                        // 4. Configura√ß√£o antes de cada teste
    void setUp() {
        // Preparar dados de teste
    }

    @Test                              // 5. Marca m√©todo como teste
    @DisplayName("Descri√ß√£o do teste") // 6. Nome leg√≠vel do teste
    void testMetodo() {
        // Arrange (preparar)
        when(repository.findById(1L)).thenReturn(Optional.of(entidade));

        // Act (executar)
        ResultadoDTO resultado = service.buscarPorId(1L);

        // Assert (verificar)
        assertNotNull(resultado);
        assertEquals("esperado", resultado.getCampo());
        verify(repository, times(1)).findById(1L);
    }
}
```

## üìã Conceitos Fundamentais

### 1. Anota√ß√µes Principais

| Anota√ß√£o | Fun√ß√£o | Exemplo |
|----------|--------|---------|
| `@ExtendWith(MockitoExtension.class)` | Integra JUnit 5 com Mockito | N√≠vel de classe |
| `@Mock` | Cria um mock (objeto simulado) | Depend√™ncias |
| `@InjectMocks` | Injeta mocks na classe testada | Classe sob teste |
| `@BeforeEach` | Executa antes de cada teste | M√©todo `setUp()` |
| `@Test` | Define um m√©todo de teste | M√©todos de teste |
| `@DisplayName` | Nome leg√≠vel para o teste | Documenta√ß√£o |

### 2. Padr√£o AAA (Arrange-Act-Assert)

Todos os testes seguem este padr√£o:

```java
@Test
void testExemplo() {
    // ARRANGE (Preparar): Configurar mocks e dados
    when(repository.save(any())).thenReturn(entidade);
    
    // ACT (Executar): Chamar o m√©todo a ser testado
    ResultadoDTO resultado = service.salvar(dto);
    
    // ASSERT (Verificar): Validar o resultado
    assertNotNull(resultado);
    assertEquals("esperado", resultado.getCampo());
    verify(repository).save(any());
}
```

### 3. Mockito - Comandos B√°sicos

#### Configurar Comportamento do Mock

```java
// Retornar valor quando m√©todo √© chamado
when(repository.findById(1L)).thenReturn(Optional.of(entidade));

// Retornar lista
when(repository.findAll()).thenReturn(Arrays.asList(entidade1, entidade2));

// Lan√ßar exce√ß√£o
when(repository.save(any())).thenThrow(new RuntimeException("Erro"));

// Fazer nada (void methods)
doNothing().when(repository).deleteById(1L);
```

#### Verificar Chamadas

```java
// Verificar se m√©todo foi chamado
verify(repository).save(any());

// Verificar n√∫mero de chamadas
verify(repository, times(1)).findById(1L);
verify(repository, never()).deleteById(anyLong());

// Verificar com argumentos espec√≠ficos
verify(repository).save(argThat(e -> e.getNome().equals("Teste")));
```

### 4. Assertions do JUnit 5

```java
// Valida√ß√µes b√°sicas
assertNotNull(resultado);                    // N√£o √© nulo
assertNull(resultado);                       // √â nulo
assertTrue(condicao);                        // √â verdadeiro
assertFalse(condicao);                       // √â falso

// Compara√ß√µes
assertEquals(esperado, atual);               // Igualdade
assertNotEquals(naoEsperado, atual);        // Diferen√ßa
assertSame(objeto1, objeto2);               // Mesma inst√¢ncia

// Cole√ß√µes
assertEquals(2, lista.size());               // Tamanho
assertTrue(lista.contains(elemento));        // Cont√©m elemento

// Exce√ß√µes
assertThrows(Exception.class, () -> {        // Lan√ßa exce√ß√£o
    service.metodoQueLancaExcecao();
});

assertDoesNotThrow(() -> {                   // N√£o lan√ßa exce√ß√£o
    service.metodoSeguro();
});
```

## üìù Exemplos Pr√°ticos

### Teste 1: Salvar Entidade

```java
@Test
@DisplayName("Deve salvar estado com sucesso")
void testSalvarEstado() {
    // Arrange
    EstadoDTO estadoDTO = EstadoDTO.builder()
        .uf("MG")
        .nome("Minas Gerais")
        .build();
    
    Estado estado = new Estado();
    estado.setId(1L);
    estado.setUf("MG");
    estado.setNome("Minas Gerais");
    
    when(estadoRepository.save(any(Estado.class))).thenReturn(estado);

    // Act
    EstadoDTO resultado = estadoService.salvar(estadoDTO);

    // Assert
    assertNotNull(resultado);
    assertEquals("MG", resultado.getUf());
    assertEquals("Minas Gerais", resultado.getNome());
    verify(estadoRepository, times(1)).save(any(Estado.class));
}
```

### Teste 2: Buscar por ID

```java
@Test
@DisplayName("Deve buscar estado por ID")
void testBuscarEstadoPorId() {
    // Arrange
    Estado estado = new Estado();
    estado.setId(1L);
    estado.setUf("MG");
    
    when(estadoRepository.findById(1L)).thenReturn(Optional.of(estado));

    // Act
    Optional<EstadoDTO> resultado = estadoService.buscarPorId(1L);

    // Assert
    assertTrue(resultado.isPresent());
    assertEquals("MG", resultado.get().getUf());
    verify(estadoRepository, times(1)).findById(1L);
}
```

### Teste 3: Entidade N√£o Encontrada

```java
@Test
@DisplayName("Deve retornar vazio quando estado n√£o existe")
void testBuscarEstadoInexistente() {
    // Arrange
    when(estadoRepository.findById(999L)).thenReturn(Optional.empty());

    // Act
    Optional<EstadoDTO> resultado = estadoService.buscarPorId(999L);

    // Assert
    assertFalse(resultado.isPresent());
    verify(estadoRepository, times(1)).findById(999L);
}
```

### Teste 4: Listar Entidades

```java
@Test
@DisplayName("Deve listar todos os estados")
void testListarTodosEstados() {
    // Arrange
    Estado estado1 = new Estado();
    estado1.setUf("MG");
    
    Estado estado2 = new Estado();
    estado2.setUf("SP");
    
    when(estadoRepository.findAll()).thenReturn(Arrays.asList(estado1, estado2));

    // Act
    List<EstadoDTO> resultado = estadoService.listarTodos();

    // Assert
    assertNotNull(resultado);
    assertEquals(2, resultado.size());
    assertEquals("MG", resultado.get(0).getUf());
    assertEquals("SP", resultado.get(1).getUf());
    verify(estadoRepository, times(1)).findAll();
}
```

### Teste 5: Deletar Entidade

```java
@Test
@DisplayName("Deve deletar estado")
void testDeletarEstado() {
    // Arrange
    doNothing().when(estadoRepository).deleteById(1L);

    // Act & Assert
    assertDoesNotThrow(() -> estadoService.deletar(1L));
    verify(estadoRepository, times(1)).deleteById(1L);
}
```

### Teste 6: Valida√ß√£o de Regra de Neg√≥cio (Exce√ß√£o)

```java
@Test
@DisplayName("Deve lan√ßar exce√ß√£o ao salvar usu√°rio com email duplicado")
void testSalvarUsuarioEmailDuplicado() {
    // Arrange
    when(usuarioRepository.existsByEmail("joao@email.com")).thenReturn(true);

    // Act & Assert
    assertThrows(EmailJaCadastradoException.class, () -> {
        usuarioService.salvar(usuarioCadastroDTO);
    });

    verify(usuarioRepository, times(1)).existsByEmail("joao@email.com");
    verify(usuarioRepository, never()).save(any(Usuario.class));
}
```

### Teste 7: Autentica√ß√£o

```java
@Test
@DisplayName("Deve autenticar usu√°rio com credenciais v√°lidas")
void testAutenticarUsuarioValido() {
    // Arrange
    Usuario usuario = new Usuario();
    usuario.setEmail("joao@email.com");
    usuario.setSenha("senha123");
    
    when(usuarioRepository.findAll()).thenReturn(Arrays.asList(usuario));

    // Act
    boolean resultado = usuarioService.autenticar("joao@email.com", "senha123");

    // Assert
    assertTrue(resultado);
    verify(usuarioRepository, times(1)).findAll();
}
```

## üöÄ Executando os Testes

### Linha de Comando

```bash
# Executar todos os testes
./mvnw test

# Windows
mvnw.cmd test

# Executar testes de uma classe espec√≠fica
./mvnw test -Dtest=EstadoServiceTest

# Executar um teste espec√≠fico
./mvnw test -Dtest=EstadoServiceTest#testSalvarEstado

# Gerar relat√≥rio de cobertura (se JaCoCo configurado)
./mvnw clean test jacoco:report
```

### IDE (IntelliJ IDEA / Eclipse)

1. **Executar todos os testes de uma classe:**
   - Clique direito na classe de teste ‚Üí "Run EstadoServiceTest"

2. **Executar um teste espec√≠fico:**
   - Clique no √≠cone ‚ñ∂Ô∏è ao lado do m√©todo `@Test`

3. **Ver cobertura:**
   - Clique direito ‚Üí "Run with Coverage"

## üìä Cobertura de Testes Atual

### Services Testados

| Service | Testes | Cobertura |
|---------|--------|--------|
| **EstadoService** | 7 | Salvar, listar, buscar, deletar, verificar exist√™ncia |
| **CidadeService** | 5 | Salvar, listar, buscar, deletar |
| **ProjetoService** | 5 | Criar, buscar, listar por usu√°rio, deletar |
| **UsuarioService** | 12 | Salvar, listar, buscar, atualizar, deletar, autenticar, buscar por username |
| **CalculoTermicoService** | 12 | C√°lculo de propriedades t√©rmicas (U, CT, RT, œÜ), carbono incorporado, valida√ß√µes |
| **MockMaterialService** | 21 | Carregar JSON, buscar por ID, filtrar, categorias, propriedades t√©rmicas, densidade |

### Tipos de Testes Implementados

‚úÖ **Testes de Sucesso**: Validam fluxo normal de execu√ß√£o  
‚úÖ **Testes de Erro**: Validam comportamento com dados inv√°lidos  
‚úÖ **Testes de Vazio**: Validam retorno quando n√£o h√° dados  
‚úÖ **Testes de Valida√ß√£o**: Verificam chamadas aos repositories  

## üéì Boas Pr√°ticas

### ‚úÖ Fazer

1. **Nomear testes claramente**
   ```java
   @DisplayName("Deve salvar estado com sucesso")
   void testSalvarEstado()
   ```

2. **Testar um comportamento por teste**
   - Cada teste deve validar apenas uma funcionalidade

3. **Usar padr√£o AAA**
   - Arrange ‚Üí Act ‚Üí Assert

4. **Verificar chamadas aos mocks**
   ```java
   verify(repository, times(1)).save(any());
   ```

5. **Usar builders para DTOs**
   ```java
   EstadoDTO dto = EstadoDTO.builder()
       .uf("MG")
       .nome("Minas Gerais")
       .build();
   ```

### ‚ùå Evitar

1. **Testes muito longos**
   - Divida em testes menores

2. **L√≥gica complexa nos testes**
   - Testes devem ser simples e diretos

3. **Depend√™ncia entre testes**
   - Cada teste deve ser independente

4. **Ignorar verifica√ß√µes**
   - Sempre use `verify()` para garantir chamadas

5. **Dados hardcoded**
   - Use o m√©todo `setUp()` para preparar dados

## üêõ Troubleshooting

### Problema: NullPointerException no teste

**Causa:** Mock n√£o configurado  
**Solu√ß√£o:** 
```java
@Mock
private IRepository repository;  // ‚úÖ Anota√ß√£o @Mock

// Configurar comportamento
when(repository.findById(1L)).thenReturn(Optional.of(entidade));
```

### Problema: Teste passa mas n√£o deveria

**Causa:** Assertions faltando  
**Solu√ß√£o:**
```java
// ‚ùå Errado
service.salvar(dto);

// ‚úÖ Correto
EstadoDTO resultado = service.salvar(dto);
assertNotNull(resultado);
assertEquals("MG", resultado.getUf());
verify(repository).save(any());
```

### Problema: Erro "UnnecessaryStubbingException"

**Causa:** Mock configurado mas n√£o usado  
**Solu√ß√£o:** Remova o `when()` n√£o utilizado ou use-o no teste

## üìö Pr√≥ximos Passos

### Services a Testar

- [x] UsuarioService ‚úÖ
- [x] CalculoTermicoService ‚úÖ
- [x] MockMaterialService ‚úÖ
- [ ] MaterialProjetoService
- [ ] ZoneamentoBioclimaticoService

### Melhorias

- [ ] Adicionar JaCoCo para relat√≥rio de cobertura
- [ ] Criar testes de integra√ß√£o
- [ ] Implementar testes parametrizados com `@ParameterizedTest`
- [ ] Adicionar testes de performance

## üîó Refer√™ncias

- [JUnit 5 User Guide](https://junit.org/junit5/docs/current/user-guide/)
- [Mockito Documentation](https://javadoc.io/doc/org.mockito/mockito-core/latest/org/mockito/Mockito.html)
- [AssertJ Documentation](https://assertj.github.io/doc/)
- [Spring Boot Testing](https://docs.spring.io/spring-boot/docs/current/reference/html/features.html#features.testing)

---

**√öltima atualiza√ß√£o:** Novembro 2025  
**Autor:** Equipe BioEdifica  
**Total de Testes:** 62 testes unit√°rios (6 services testados)
